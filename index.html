
<!DOCTYPE html>
<html>
<head>
    <title>Ableton Metrolink</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Ableton Metrolink</h1>
        <div id="status">Connecting...</div>

        <div id="metronome">
            <div class="beat-pulse"></div>
            <div id="position">1.1</div>
            <div id="bpm">120 BPM</div>
        </div>

        <div class="beat-indicators">
            <div class="beat-indicator downbeat" id="beat1"></div>
            <div class="beat-indicator" id="beat2"></div>
            <div class="beat-indicator" id="beat3"></div>
            <div class="beat-indicator" id="beat4"></div>
        </div>

        <div class="controls">
            <button id="startBtn" onclick="sendCommand('start')">▶ Start</button>
            <button id="stopBtn" onclick="sendCommand('stop')" disabled>⏹ Stop</button>
        </div>
    </div>

    <script>
        // Optimized mobile version
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);
        const updateInterval = isMobile ? 100 : 50;

        const metronome = document.getElementById('metronome');
        const positionDisplay = document.getElementById('position');
        const bpmDisplay = document.getElementById('bpm');
        const statusDisplay = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const beatIndicators = [
            document.getElementById('beat1'),
            document.getElementById('beat2'),
            document.getElementById('beat3'),
            document.getElementById('beat4')
        ];

        let currentData = {
            position: "1.1",
            bpm: 120,
            is_downbeat: false,
            transport_running: false
        };
        let lastUpdate = 0;
        let socket;

        function connectWebSocket() {
            const serverIP = window.location.hostname || 'localhost';
            socket = new WebSocket(`ws://${serverIP}:8765`);

            socket.onopen = () => {
                statusDisplay.textContent = '✅ Połączono z serwerem MIDI';
                statusDisplay.className = '';
                console.log('Połączenie WebSocket otwarte');
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log("Received MIDI update:", data);

                    // Filtruj nierealne wartości
                    if (data.bpm < 20 || data.bpm > 300) {
                        console.warn("Unrealistic BPM value:", data.bpm);
                        return;
                    }

                    // Aktualizuj tylko jeśli dane się zmieniły lub minął określony czas
                    if (data.position !== currentData.position ||
                        performance.now() - lastUpdate >= updateInterval) {

                        lastUpdate = performance.now();

                        // Wygładzanie BPM
                        currentData.bpm = currentData.bpm
                            ? 0.3 * data.bpm + 0.7 * currentData.bpm
                            : data.bpm;

                        // Aktualizacja pozostałych danych
                        currentData.position = data.position;
                        currentData.is_downbeat = data.is_downbeat;
                        currentData.transport_running = data.transport_running;

                        // Wymuś natychmiastową aktualizację UI
                        updateUI();
                    }
                } catch (error) {
                    console.error('Błąd przetwarzania danych MIDI:', error);
                }
            };

            socket.onerror = (error) => {
                console.error('Błąd WebSocket:', error);
                statusDisplay.textContent = '❌ Błąd połączenia z serwerem';
                statusDisplay.className = 'status-error';
            };

            socket.onclose = () => {
                console.log('Połączenie WebSocket zamknięte');
                statusDisplay.textContent = '❌ Połączenie zamknięte - próba ponownego połączenia...';
                statusDisplay.className = 'status-error';
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateUI() {
            // Aktualizacja wyświetlania
            positionDisplay.textContent = currentData.position;
            bpmDisplay.textContent = `${Math.round(currentData.bpm)} BPM`;

            // Aktualizacja wskaźników beatów
            const [bar, beat] = currentData.position.split('.').map(Number);
            const beatIndex = beat - 1;

            beatIndicators.forEach((indicator, index) => {
                const isActive = index === beatIndex;
                indicator.classList.toggle('active', isActive);
                indicator.classList.toggle('downbeat', isActive && currentData.is_downbeat);
            });

            // Aktualizacja pulsu metronomu
            metronome.classList.remove('downbeat', 'beat');
            if (beatIndex >= 0) {
                metronome.classList.add(currentData.is_downbeat ? 'downbeat' : 'beat');
            }

            // Aktualizacja stanu przycisków
            startBtn.disabled = currentData.transport_running;
            stopBtn.disabled = !currentData.transport_running;
        }

        function sendCommand(type) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type }));
                console.log(`Wysłano komendę: ${type}`);
            } else {
                console.error('Połączenie WebSocket nie jest otwarte');
            }
        }

        // Inicjalizacja połączenia
        connectWebSocket();
    </script>
</body>
</html>